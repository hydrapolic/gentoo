#!/sbin/openrc-run
# Copyright 1999-2018 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2

command="/usr/bin/java"
command_args="${JAVA_OPTS} -jar ${GRAYLOG_INSTALL_DIR}/graylog.jar server -f ${GRAYLOG_CONFIG_FILE} --no-pid-file ${GRAYLOG_OPTIONS}"
command_background="true"
command_user="${GRAYLOG_USER}:${GRAYLOG_GROUP}"
pidfile="/run/${RC_SVCNAME}.pid"

output_log="${GRAYLOG_LOG_DIR}/graylog.stdout.log"
error_log="${GRAYLOG_LOG_DIR}/graylog.stderr.log"
directory="${GRAYLOG_INSTALL_DIR}"

depend() {
	need net
}

start_pre() {
	if [ ! -f "${GRAYLOG_CONFIG_FILE}" ]; then
		eerror "Missing configuration file ${GRAYLOG_CONFIG_FILE}"
		return 1
	fi

	local d
	for d in \
		"${GRAYLOG_DATA_DIR}" \
		"${GRAYLOG_DATA_DIR}/data" \
		"${GRAYLOG_DATA_DIR}/data/contentpacks" \
		"${GRAYLOG_DATA_DIR}/data/journal" \
		"${GRAYLOG_LOG_DIR}"; do
	
		checkpath -d -o "${GRAYLOG_USER}":"${GRAYLOG_GROUP}" -m750 "${d}"
	done
}
